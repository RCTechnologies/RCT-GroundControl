os:
- linux
language:
- node_js
node_js:
- '6.5'
branches:
  only:
  - master
  - /^ready\/.*$/

sudo: required

before_script:
- echo Start Virtual Screen
- export DISPLAY=:99.0
- sh -e /etc/init.d/xvfb start
- sleep 3

- echo Install Dependencies
- npm install
- sudo apt-get install python-pip python-dev
- sudo pip install dronekit
- sudo pip install dronekit-sitl

- echo Package project
- npm run package:linux

- echo Set Environment variables
- export BRANCH=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then echo $TRAVIS_BRANCH;
  else echo $TRAVIS_PULL_REQUEST_BRANCH; fi)
- echo "TRAVIS_BRANCH=$TRAVIS_BRANCH, PR=$PR, BRANCH=$BRANCH"

script:
- npm run coverage

after_success:
- |-
  if [ "$TRAVIS_BRANCH" != "master" ];
  then git clone "https://github.com/"$TRAVIS_REPO_SLUG".git" repo_temp;
  cd repo_temp;

  echo Mergin;
  git merge --ff-only origin/"$TRAVIS_BRANCH";

  echo Pushing;
  git push https://$GH_TOKEN@github.com/$TRAVIS_REPO_SLUG master ;
  git push https://$GH_TOKEN@github.com/"$TRAVIS_REPO_SLUG" --delete "$BRANCH";

  else echo Was directly on master; fi

after_script:
- |-
  if [ "$TRAVIS_BRANCH" == "master" ];
    then echo Pull Tags;
    git fetch --tags;

    echo get Latest Tag;
    VERSION=`git describe --tags $(git rev-list --tags --max-count=1)`;
    VERSION_BITS=(${VERSION//./ });
    VNUM1=${VERSION_BITS[0]};
    VNUM2=${VERSION_BITS[1]};
    VNUM3=${VERSION_BITS[2]};
    echo $VERSION;

    echo Run Build Chain;
    npm run check && echo End of Chain Reached - can Update Tag && if [ "$TRAVIS_BRANCH" == "master" ];
          then echo Tag update Minor;
          VNUM2=$((VNUM2+1));
          VNUM3=0;

          NEW_TAG="$VNUM1.$VNUM2.$VNUM3";
          echo "Updating $VERSION to $NEW_TAG";
          git tag $NEW_TAG;
          git push https://$GH_TOKEN@github.com/$TRAVIS_REPO_SLUG --tags;
        fi

        TEST=$(git tag -l --contains HEAD 2>&1);
        echo test: $TEST;

        if [ -z "$TEST" ];
          then echo Tag Update Patch;
          VNUM3=$((VNUM3+1));

          NEW_TAG="$VNUM1.$VNUM2.$VNUM3";
          echo "Updating $VERSION to $NEW_TAG";
          git tag $NEW_TAG;
          git push https://$GH_TOKEN@github.com/$TRAVIS_REPO_SLUG --tags;
        fi
  fi

cache:
  directories:
  - node_modules

notifications:
  email:
    on_success: never
    on_failure: change

env:
  global:
    secure: OmJ9XO8x/3hLZEDngCMo4z6SeFIHpfQ7TWCjk0aB8i8P/+oWjklJv5iEIYlHfquCInx64rMXQzPPkbbqwcyPyjhxkbe58Jq2Pygrrw/VbK7tdbcjGdExrQP7+a3aUIasc2SzWKB1QCJdXCD3oyYotuCTzevCwBtHUYeiGhgYdNEVXhBRWX+8ISfHyNtWAr0B1lVpJ5W6Lh5p3U9pJXWa2mDxCPITCULBIxSZMosdxYYdXi2MUFanD2wNsX9ow+htkeE1I9brtT3nUzilKhcv6Zzo9nNLc9kNFH6XlsRd1Mm6Q6HHRJPD2vpXWIepRDGSc/Aw5jezt/5n/DEavmTnhm+zYoCuu2bScdXZBJQmVz8udE+2+m8UO3QlM50FEiDVeTS8VOq40vQa32Mau3ce5+OlSRgodl5NOpZv6gTJu+E3kOQO6DHkpNZFq3oprcg5jdt4QIXpnC7zcGQdUUGnycsC2mMxit/mP/dbU61KwspfZqViTkXwUIvlX32Bb/afN7Jo5VOi/JfcEfGYLMcZ/BTWTNEIctK0kX7MdqhiD0Ij+aoNCipK8oh3u/OKvZLLLmBOCpMm93vjafVk4+hWPdMwpFZiviOcg+SOBqhUvnmq89KVLbgB8uMWGKNzOVZzDSps3ngucgrJKiB64Xt8Uo8QH+27ND5gZ49pqzVBJJc=
